عنوان: خطة تنفيذ ميزة رسائل واتساب التلقائية في Tabibi

ملخص قصير
- الهدف: إرسال رسائل واتساب تلقائية للمرضى عند الحجز، ثم تذكير قبل الموعد بزمن مُخصص، مع إمكانية تخصيص الرسائل وتشغيل/إيقاف كل إرسال.
- النطاق: إعدادات الطبيب/العيادة، تعديلات قاعدة البيانات، جدولة التذكيرات، تكامل API، تجربة استخدام على الموبايل أولًا.
- الاعتمادات الحالية: مخطط قاعدة البيانات الحالي [database.txt](file:///c:/Users/hp/Desktop/Dev/tabibi-master/database.txt) وتوثيق API للواتساب [whatsapp-api.txt](file:///C:/Users/hp/Desktop/Dev/tabibi-master/whatsapp-api.txt).

البيانات المطلوبة من فريق Tabibi
- Master Token: مفتاح API واحد موحد للحساب الرئيسي (يتم توفيره من قبلك) للتحكم في جميع العيادات.
- تفعيل Edge Functions وpg_cron في Supabase (موجودة لدينا ويُستخدم نمط مشابه في إرسال الإيميلات اليومية).
- تهيئة مفاتيح الخدمة: Supabase Service Role Key ضمن إعدادات المشروع.
- إضافة Master Token إلى متغيرات البيئة (Env Vars) في Supabase Edge Functions باسم `MESSAGE_PRO_TOKEN`.
- اعتماد صيغة توحيد أرقام الهاتف المصرية إلى E.164 (+201XXXXXXXXX).

البيانات المطلوبة من الطبيب (أو المسؤول عن النظام لكل عيادة)
- instance_id (أو unique name): معرّف جلسة واتساب الخاصة بالعيادة (يتم إنشاؤه في لوحة تحكم Message-Pro وربطه بالعيادة).
- تفعيل/إيقاف الإرسال الفوري بعد الحجز.
- تفعيل/إيقاف تذكير ما قبل الموعد.
- زمن التذكير بالدقائق.
- نص رسالة الحجز الفوري (قابل للتخصيص).
- نص رسالة التذكير (قابل للتخصيص).
* ملاحظة: لا حاجة لطلب token من الطبيب؛ سيتم استخدام الـ Master Token للنظام.

التغييرات المقترحة على قاعدة البيانات (SQL)
1) تخزين بيانات التكامل مع Message-Pro (بدون token لكل عيادة)
- نستخدم جدول integrations لربط العيادة بـ instance_id.
- الحقل access_token سيكون NULL (أو غير مستخدم لهذا النوع) لأننا نستخدم Token موحد.
- يتم تخزين instance_id داخل عمود settings.

مثال SQL (إدراج/تحديث):
INSERT INTO public.integrations (id, user_id, clinic_id, provider, integration_type, settings, is_active, created_at, updated_at)
VALUES (
  gen_random_uuid(),
  NULL,
  :clinic_id::uuid,
  'message-pro',
  'whatsapp',
  jsonb_build_object('instance_id', :instance_id), -- تخزين الـ instance_id فقط
  TRUE,
  now(),
  now()
)
ON CONFLICT (clinic_id, provider, integration_type) DO UPDATE SET
  settings = EXCLUDED.settings,
  is_active = EXCLUDED.is_active,
  updated_at = now();

ملاحظة: نحتاج إلى فهرس/قيد تفرد اختياري:
CREATE UNIQUE INDEX IF NOT EXISTS integrations_unique_clinic_provider_type
ON public.integrations (clinic_id, provider, integration_type)
WHERE clinic_id IS NOT NULL;

2) جدول إعدادات واتساب لكل عيادة (قوالب وتبديل تشغيل/إيقاف)
CREATE TABLE public.whatsapp_settings (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  clinic_id uuid NOT NULL, -- نفس النمط المستخدم في معظم الجداول لدينا بدون FK
  enabled_immediate boolean DEFAULT true,
  enabled_reminder boolean DEFAULT true,
  reminder_offset_minutes integer DEFAULT 30 CHECK (reminder_offset_minutes BETWEEN 1 AND 720),
  immediate_template text DEFAULT 'تم تأكيد حجزك في {clinic_name} يوم {date} الساعة {time}. من فضلك احضر قبل 10 دقائق.',
  reminder_template text DEFAULT 'باقي {offset} دقيقة على ميعادك في {clinic_name} الساعة {time}. نورتنا.',
  updated_at timestamptz DEFAULT now(),
  UNIQUE (clinic_id)
);

3) تتبّع حالة الإرسال داخل جدول المواعيد
ALTER TABLE public.appointments ADD COLUMN IF NOT EXISTS whatsapp_booking_sent boolean DEFAULT false;
ALTER TABLE public.appointments ADD COLUMN IF NOT EXISTS whatsapp_reminder_sent boolean DEFAULT false;
ALTER TABLE public.appointments ADD COLUMN IF NOT EXISTS whatsapp_booking_message_id text;
ALTER TABLE public.appointments ADD COLUMN IF NOT EXISTS whatsapp_reminder_message_id text;

4) سجل رسائل واتساب (للتدقيق واستكشاف الأخطاء)
CREATE TABLE public.whatsapp_message_logs (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  clinic_id uuid NOT NULL,
  appointment_id bigint,
  patient_id bigint,
  message_type text NOT NULL CHECK (message_type = ANY (ARRAY['booking','reminder'])),
  status text NOT NULL CHECK (status = ANY (ARRAY['sent','failed','skipped'])),
  message_id text,
  error_message text,
  request_payload jsonb DEFAULT '{}'::jsonb,
  response_payload jsonb DEFAULT '{}'::jsonb,
  sent_at timestamptz DEFAULT now(),
  created_at timestamptz DEFAULT now()
);

5) جدولة تذكير الواتساب (pg_cron + Edge Function)
- نفس نمط إرسال الإيميل اليومي [setup-daily-email-cron.sql](file:///c:/Users/hp/Desktop/Dev/tabibi-master/setup-daily-email-cron.sql)
CREATE EXTENSION IF NOT EXISTS pg_cron;
GRANT USAGE ON SCHEMA cron TO postgres;

SELECT cron.schedule(
  'send-whatsapp-reminders',
  '* * * * *',  -- تشغيل كل دقيقة لتفقد المواعيد القادمة
  $$
  SELECT net.http_post(
    url := current_setting('app.settings.supabase_url') || '/functions/v1/send-whatsapp-reminders',
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer ' || current_setting('app.settings.service_role_key')
    ),
    body := '{}'::jsonb
  );
  $$
);

تأثيرات على الجداول والسياسات
- جميع الجداول الجديدة تعتمد نفس سياسة RLS المستخدمة حاليًا: التحقق من clinic_id لكي يرى كل مستخدم إشعارات/سجلات عيادته فقط.
- سنضيف سياسات SELECT/INSERT/UPDATE على whatsapp_settings وwhatsapp_message_logs مطابقة لجدول notifications.

التدفق الوظيفي المقترح
1) الإرسال الفوري بعد الحجز (online booking أو من العيادة)
- نقطة التنفيذ: طبقة التطبيق بعد نجاح إدراج الموعد:
  - useCreateAppointmentPublic و createAppointment في [apiAppointments.js](file:///c:/Users/hp/Desktop/Dev/tabibi-master/src/services/apiAppointments.js#L338-L388) هي نقاط مناسبة.
- منطق العمل:
  - جلب إعدادات العيادة من whatsapp_settings.
  - التحقق من enabled_immediate.
  - تجهيز القالب immediate_template بمتغيرات التاريخ/الوقت/اسم المريض/اسم العيادة.
  - توحيد رقم المريض إلى E.164.
  - استدعاء API الإرسال.
  - تخزين message_id والنتيجة في appointments وwhatsapp_message_logs.
- إشعار داخلي: لدينا بالفعل تريجر إشعار عند إدراج موعد [setup_notifications_trigger.sql](file:///c:/Users/hp/Desktop/Dev/tabibi-master/setup_notifications_trigger.sql).

2) التذكير قبل الموعد بزمن مُخصص
- نقطة التنفيذ: Edge Function (send-whatsapp-reminders) تُستدعى كل دقيقة عبر pg_cron.
- منطق العمل داخل الـ Function:
  - جلب العيادات النشطة في الواتساب (integrations.provider='message-pro' وintegration_type='whatsapp' وis_active=true).
  - جلب إعدادات كل عيادة (enabled_reminder، reminder_offset_minutes، reminder_template).
  - الاستعلام عن المواعيد القادمة حيث:
    - whatsapp_reminder_sent = false
    - الآن داخل نافذة التذكير: 0 <= (appointment.date - now) <= offset بالدقائق
  - إعداد الرسالة وإرسالها عبر API.
  - تحديث appointments + تسجيل في whatsapp_message_logs.

تخصيص الرسائل والزمن من صفحة الإعدادات
- الموقع: صفحة الإعدادات/العيادة ضمن features/clinic (نقترح قسم "رسائل واتساب").
- عناصر واجهة:
  - مفتاح تشغيل/إيقاف الإرسال الفوري (Switch).
  - مفتاح تشغيل/إيقاف التذكير (Switch).
  - حقل رقم الدقائق (Input رقمية مع حدود 1–720).
  - محرر نصي بسيط لقالب رسالة الحجز الفوري (Textarea).
  - محرر نصي بسيط لقالب رسالة التذكير (Textarea).
- معايير Mobile-First للسوق المصري:
  - جميع العناصر بارتفاع لمسي ≥ 44px، محاذاة واضحة، نص عربي عالي التباين.
  - استخدام مكوّنات Tabibi الحالية (switch.jsx, input.jsx, textarea.jsx, button.jsx) لضمان الاتساق البصري.
  - نسخ عربية مفهومة للطبيب، وتلميحات توضح المتغيرات المتاحة داخل القوالب.

كيفية التواصل مع API
- الإرسال النصي (رسالة بسيطة):
  - Endpoint: https://api.message-pro.com/api/v2/{instance_id}/send-message
  - Headers: token: <MESSAGE_PRO_TOKEN> (من متغيرات البيئة), Content-Type: application/json
  - يتم جلب instance_id من إعدادات العيادة (جدول integrations) واستخدامه في الرابط.
  - Body:
    {
      "chat_id": "<E164 أو pn>",
      "text": "نص الرسالة بعد استبدال المتغيرات",
      "priority": 0
    }
- المخرجات المتوقعة: message_id أو حالة/خطأ؛ نخزنها في whatsapp_message_logs وappointments.*message_id.
- تحويل الرقم:
  - إزالة أي محارف غير رقمية.
  - إذا بدأ بـ 0 (010/011/012/015) → استبدال 0 بـ +20.
  - إذا بدأ بـ 20 دون + → إضافة +20.
  - التحقق النهائي بطول 12–13 ومحارف رقمية فقط.

القوالب والمتغيرات
- المتغيرات المدعومة داخل النص:
  - {clinic_name} من جدول clinics.name.
  - {patient_name} من patients.name.
  - {patient_phone} بعد التوحيد.
  - {date} و{time} من appointments.date (تنسيق أر-سا).
  - {offset} قيمة الدقائق المفعّلة للتذكير.
  - {appointment_id} معرف الموعد.
- مثال قالب فوري:
  "تم تأكيد حجزك في {clinic_name} يوم {date} الساعة {time}. من فضلك احضر قبل 10 دقائق."
- مثال قالب تذكير:
  "باقي {offset} دقيقة على معادك في {clinic_name} الساعة {time}. نورتنا." 

تشغيل/إيقاف الإرسالين
- يعتمد كل إرسال على enabled_immediate وenabled_reminder في whatsapp_settings.
- عند الإيقاف، تتخطى الوظائف الإرسال وتُسجِّل حالة "skipped" في whatsapp_message_logs للتتبع.

تحليل التأثيرات على أجزاء المشروع الأخرى
- قاعدة البيانات:
  - إضافة جداول/أعمدة جديدة كما أعلاه، مع سياسات RLS مماثلة لـ notifications.
- طبقة الخدمات:
  - إضافة خدمة WhatsApp integration مشابهة لـ integrationService مع مزوّد message-pro.
  - تعديل createAppointment / createAppointmentPublic لإرسال الفوري (بدون تعطيل أي سلوك حالي مثل إشعار النظام أو Google Calendar).
- الجدولة:
  - إضافة Edge Function وpg_cron entry على غرار daily email.
- الواجهة:
  - قسم إعدادات في صفحة العيادة، يستخدم مكونات موجودة، ويحترم Tabibi Design System.
- الإشعارات الداخلية:
  - لا تغيير جوهري؛ نحتفظ بالتريجر الحالي، ويمكن إضافة إشعار "تم إرسال واتساب" اختياريًا.

اعتبارات الأمان والامتثال
- تخزين token داخل جدول integrations فقط مع RLS مناسبة.
- عدم تسجيل الأسرار في السجلات، وتقييد الوصول حسب clinic_id.
- احترام موافقة المريض على رسائل واتساب، وإمكانية الإيقاف لاحقًا.

استراتيجية التحقق والاختبار
- اختبارات وحدة لخدمة توحيد أرقام الهاتف.
- اختبارات تكامل للإرسال الفوري بعد إنشاء موعد وهمي.
- محاكاة Edge Function محليًا واختبار نافذة التذكير.
- تحقق من سيناريوهات الخطأ: رقم غير صحيح، token خاطئ، instance_id غير صالح، انقطاع اتصال.
- مراقبة whatsapp_message_logs للتأكد من التتبّع.

خطة تدريجية للتنفيذ
1) إنشاء جداول/أعمدة DB (whatsapp_settings، logs، أعمدة appointments، وفهرس integrations).
2) إضافة خدمة تكامل Message-Pro (جلب token/instance من integrations).
3) تطوير وظيفة الإرسال الفوري، ودمجها مع createAppointment وcreateAppointmentPublic.
4) تطوير Edge Function للتذكير، وضبط pg_cron كل دقيقة.
5) صفحة الإعدادات (Mobile-First) لتبديل التشغيل، ضبط الدقائق، تحرير القوالب.
6) اختبارات وتحقق شامل، ثم إطلاق تدريجي على عيادات محددة.

متطلبات واجهة المستخدم (Mobile-First) للسوق المصري
- عناصر كبيرة وواضحة، اللغة: العربية المصرية.
- مسارات مختصرة: من صفحة الإعدادات، تغييرات بنقرة واحدة.
- استخدام تباين لوني مريح متوافق مع Tabibi.
- دعم التكبير النصي وقرّاء الشاشة (WCAG 2.1 AA).
- التعامل مع ضعف الاتصال: قائمة انتظار وخطأ مفهوم للطبيب.

روابط مرجعية داخل المشروع
- مخطط القاعدة: [database.txt](file:///c:/Users/hp/Desktop/Dev/tabibi-master/database.txt)
- توثيق API: [whatsapp-api.txt](file:///C:/Users/hp/Desktop/Dev/tabibi-master/whatsapp-api.txt)
- إشعار تلقائي بعد إنشاء الموعد (تريجر): [setup_notifications_trigger.sql](file:///c:/Users/hp/Desktop/Dev/tabibi-master/setup_notifications_trigger.sql)
- جدولة الإيميل اليومي كنموذج: [setup-daily-email-cron.sql](file:///c:/Users/hp/Desktop/Dev/tabibi-master/setup-daily-email-cron.sql)

ملاحظات أخيرة
- لا تغييرات في الكود الآن؛ هذا المستند هو الخطة التفصيلية بكافة النقاط.
- أي تعديل سننفّذه لاحقًا سنراجع تأثيره على بقية الملفات ونُعالج الاعتمادية قبل الدمج.
