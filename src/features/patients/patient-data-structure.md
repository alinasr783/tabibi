# هيكلة بيانات المريض ونظام التواصل مع قاعدة البيانات

## 1. نظرة عامة
تم تصميم نظام بيانات المريض ليكون مرناً وقابلاً للتوسع، مع التركيز على سهولة الاستخدام للطبيب وسرعة الأداء. يعتمد النظام على دمج البيانات المهيكلة (مثل الاسم ورقم الهاتف) مع البيانات شبه المهيكلة (JSONB) للتفاصيل الطبية المتغيرة.

## 2. هيكلة قاعدة البيانات (Database Schema)

### جدول المرضى (`patients`)
هذا هو الجدول الرئيسي، وتم تحديثه ليشمل الحقول التالية:

| الحقل | النوع | الوصف | ملاحظات |
|-------|-------|-------|---------|
| `id` | `bigint` | المعرف الفريد للمريض | مفتاح أساسي |
| `clinic_id` | `uuid` | معرف العيادة | لربط المريض بالعيادة |
| `name` | `text` | اسم المريض | **إجباري** |
| `phone` | `text` | رقم الهاتف | **إجباري** |
| `age` | `integer` | العمر | |
| `gender` | `text` | النوع | ذكر/أنثى |
| `job` | `text` | الوظيفة | *جديد* |
| `marital_status` | `text` | الحالة الاجتماعية | *جديد* |
| `address` | `text` | العنوان | |
| `email` | `text` | البريد الإلكتروني | *جديد* |
| `medical_history` | `jsonb` | السجل الطبي الشامل | *جديد* - انظر التفاصيل أدناه |
| `insurance_info` | `jsonb` | بيانات التأمين | *جديد* - انظر التفاصيل أدناه |
| `created_at` | `timestamp` | تاريخ الإنشاء | |

### تفاصيل حقل السجل الطبي (`medical_history` - JSONB)
يتم تخزين البيانات الطبية في هيكل JSON مرن:
```json
{
  "chief_complaint": "نص الشكوى الرئيسية",
  "chronic_diseases": ["ضغط", "سكر"],
  "blood_pressure": "120/80",
  "blood_sugar": "100",
  "blood_type": "O+",
  "allergies": ["بنسلين", "سمسم"],
  "past_surgeries": ["استئصال لوز"],
  "family_history": ["والد مريض سكر"]
}
```

### تفاصيل حقل التأمين (`insurance_info` - JSONB)
```json
{
  "provider_name": "اسم شركة التأمين",
  "policy_number": "رقم البوليصة",
  "coverage_percent": 80,
  "expiration_date": "2025-12-31"
}
```

### جدول المرفقات (`patient_attachments`)
جدول جديد منفصل لتخزين روابط الملفات:

| الحقل | النوع | الوصف |
|-------|-------|-------|
| `id` | `uuid` | معرف المرفق |
| `patient_id` | `bigint` | معرف المريض |
| `file_url` | `text` | رابط الملف في التخزين السحابي |
| `file_type` | `text` | نوع الملف (image/pdf) |
| `category` | `text` | تصنيف (تحاليل، أشعة، أخرى) |
| `created_at` | `timestamp` | تاريخ الرفع |

## 3. التخزين السحابي (Storage)
يتم رفع الملفات في **Supabase Storage** في Bucket مخصص:
*   **اسم الـ Bucket:** `patient-attachments`
*   **مسار الملف:** `{clinic_id}/{patient_id}/{filename}`
    *   يضمن هذا الهيكل تنظيم الملفات وعزل بيانات العيادات عن بعضها.

## 4. تدفق البيانات (Data Flow)

### عند إضافة مريض جديد
1.  يملأ الطبيب البيانات الأساسية (الاسم، الهاتف) في الخطوة الأولى.
2.  يتم إرسال طلب `INSERT` لجدول `patients`.
3.  إذا أكمل الطبيب باقي الخطوات، يتم إرسال طلب `UPDATE` لإضافة البيانات الطبية والتأمين في حقول JSONB.
4.  في حال رفع ملفات، يتم رفعها أولاً للـ Storage، ثم حفظ روابطها في جدول `patient_attachments`.

### عند عرض ملف المريض
1.  يتم جلب بيانات المريض الأساسية + JSONB من جدول `patients`.
2.  يتم جلب آخر الزيارات من جدول `visits`.
3.  يتم جلب المواعيد من جدول `appointments`.
4.  يتم جلب المرفقات من جدول `patient_attachments`.
5.  يتم جلب البيانات المالية وحسابها آنياً.

## 5. واجهة المستخدم (UI Architecture)
*   **نموذج الإضافة:** `Wizard Form` متعدد الخطوات لتقليل التعقيد.
*   **صفحة البروفيل:** تصميم `Dashboard` مصغر يعرض أهم المعلومات (Vital Bar) في الأعلى، مع تبويبات للتفاصيل.
