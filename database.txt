-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.affiliate_commissions (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  affiliate_user_id uuid NOT NULL,
  clinic_id uuid NOT NULL,
  subscription_id bigint NOT NULL UNIQUE,
  base_amount numeric NOT NULL DEFAULT 0,
  commission_rate numeric NOT NULL DEFAULT 0.1,
  commission_amount numeric NOT NULL,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'approved'::text, 'paid'::text, 'void'::text])),
  available_at timestamp with time zone NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  paid_at timestamp with time zone,
  withdrawal_request_id uuid,
  CONSTRAINT affiliate_commissions_pkey PRIMARY KEY (id),
  CONSTRAINT affiliate_commissions_affiliate_user_id_fkey FOREIGN KEY (affiliate_user_id) REFERENCES public.affiliate_users(user_id),
  CONSTRAINT affiliate_commissions_subscription_id_fkey FOREIGN KEY (subscription_id) REFERENCES public.subscriptions(id),
  CONSTRAINT affiliate_commissions_withdrawal_request_id_fkey FOREIGN KEY (withdrawal_request_id) REFERENCES public.affiliate_withdrawal_requests(id)
);
CREATE TABLE public.affiliate_link_events (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  referral_code text NOT NULL,
  event_type text NOT NULL CHECK (event_type = 'open'::text),
  path text,
  referrer text,
  user_agent text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT affiliate_link_events_pkey PRIMARY KEY (id)
);
CREATE TABLE public.affiliate_payment_settings (
  affiliate_user_id uuid NOT NULL,
  payout_method text NOT NULL DEFAULT 'bank'::text CHECK (payout_method = ANY (ARRAY['bank'::text, 'wallet'::text])),
  bank_name text,
  account_name text,
  iban text,
  wallet_phone text,
  notes text,
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT affiliate_payment_settings_pkey PRIMARY KEY (affiliate_user_id),
  CONSTRAINT affiliate_payment_settings_affiliate_user_id_fkey FOREIGN KEY (affiliate_user_id) REFERENCES public.affiliate_users(user_id)
);
CREATE TABLE public.affiliate_payout_methods (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  affiliate_user_id uuid NOT NULL,
  payout_method text NOT NULL DEFAULT 'bank'::text CHECK (payout_method = ANY (ARRAY['bank'::text, 'wallet'::text])),
  bank_name text,
  account_name text,
  iban text,
  wallet_phone text,
  notes text,
  is_default boolean NOT NULL DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT affiliate_payout_methods_pkey PRIMARY KEY (id),
  CONSTRAINT affiliate_payout_methods_affiliate_user_id_fkey FOREIGN KEY (affiliate_user_id) REFERENCES public.affiliate_users(user_id)
);
CREATE TABLE public.affiliate_referrals (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  affiliate_user_id uuid NOT NULL,
  clinic_id uuid NOT NULL UNIQUE,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT affiliate_referrals_pkey PRIMARY KEY (id),
  CONSTRAINT affiliate_referrals_affiliate_user_id_fkey FOREIGN KEY (affiliate_user_id) REFERENCES public.affiliate_users(user_id)
);
CREATE TABLE public.affiliate_users (
  user_id uuid NOT NULL,
  referral_code text NOT NULL UNIQUE,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT affiliate_users_pkey PRIMARY KEY (user_id),
  CONSTRAINT affiliate_users_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.affiliate_withdrawal_items (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  request_id uuid NOT NULL,
  commission_id bigint NOT NULL UNIQUE,
  CONSTRAINT affiliate_withdrawal_items_pkey PRIMARY KEY (id),
  CONSTRAINT affiliate_withdrawal_items_request_id_fkey FOREIGN KEY (request_id) REFERENCES public.affiliate_withdrawal_requests(id),
  CONSTRAINT affiliate_withdrawal_items_commission_id_fkey FOREIGN KEY (commission_id) REFERENCES public.affiliate_commissions(id)
);
CREATE TABLE public.affiliate_withdrawal_requests (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  affiliate_user_id uuid NOT NULL,
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'approved'::text, 'rejected'::text, 'processed'::text, 'paid'::text])),
  payout_snapshot jsonb NOT NULL DEFAULT '{}'::jsonb,
  admin_note text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  payout_method_id uuid,
  CONSTRAINT affiliate_withdrawal_requests_pkey PRIMARY KEY (id),
  CONSTRAINT affiliate_withdrawal_requests_affiliate_user_id_fkey FOREIGN KEY (affiliate_user_id) REFERENCES public.affiliate_users(user_id),
  CONSTRAINT affiliate_withdrawal_requests_payout_method_id_fkey FOREIGN KEY (payout_method_id) REFERENCES public.affiliate_payout_methods(id)
);
CREATE TABLE public.ai_agent_profile (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  bio text,
  avatar_url text,
  banner_url text,
  skills jsonb DEFAULT '[]'::jsonb,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  CONSTRAINT ai_agent_profile_pkey PRIMARY KEY (id)
);
CREATE TABLE public.app_data_submissions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  app_id bigint NOT NULL,
  clinic_id uuid,
  submission_type text NOT NULL,
  data jsonb NOT NULL DEFAULT '{}'::jsonb,
  status text DEFAULT 'new'::text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT app_data_submissions_pkey PRIMARY KEY (id),
  CONSTRAINT app_data_submissions_app_id_fkey FOREIGN KEY (app_id) REFERENCES public.tabibi_apps(id),
  CONSTRAINT app_data_submissions_clinic_id_fkey FOREIGN KEY (clinic_id) REFERENCES public.clinics(clinic_uuid)
);
CREATE TABLE public.app_developers (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  name text NOT NULL,
  company_name text,
  email text NOT NULL,
  phone text,
  website text,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'approved'::text, 'suspended'::text])),
  api_key text UNIQUE,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT app_developers_pkey PRIMARY KEY (id),
  CONSTRAINT app_developers_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.app_requests (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  developer_id uuid NOT NULL,
  title text NOT NULL,
  description text,
  image_url text,
  screenshots jsonb DEFAULT '[]'::jsonb,
  links jsonb DEFAULT '{}'::jsonb,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'in_review'::text, 'approved'::text, 'rejected'::text])),
  admin_notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  marketing_plan text,
  marketing_channels text,
  can_market boolean NOT NULL DEFAULT false,
  attachments jsonb NOT NULL DEFAULT '[]'::jsonb,
  CONSTRAINT app_requests_pkey PRIMARY KEY (id),
  CONSTRAINT app_requests_developer_id_fkey FOREIGN KEY (developer_id) REFERENCES public.app_developers(id)
);
CREATE TABLE public.app_subscriptions (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  clinic_id uuid NOT NULL,
  app_id bigint,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'expired'::text, 'cancelled'::text, 'past_due'::text])),
  current_period_start timestamp with time zone DEFAULT now(),
  current_period_end timestamp with time zone,
  billing_period text,
  amount numeric,
  auto_renew boolean DEFAULT true,
  is_integrated boolean DEFAULT false,
  pricing_type text,
  payment_type text,
  interval_unit text,
  interval_count integer,
  trial_interval_unit text,
  trial_interval_count integer,
  trial_end timestamp with time zone,
  currency text,
  CONSTRAINT app_subscriptions_pkey PRIMARY KEY (id),
  CONSTRAINT app_subscriptions_app_id_fkey FOREIGN KEY (app_id) REFERENCES public.tabibi_apps(id)
);
CREATE TABLE public.appointments (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  patient_id bigint,
  date text,
  notes text,
  status text,
  price bigint,
  from text,
  clinic_id uuid,
  age bigint,
  diagnosis text,
  treatment text,
  custom_fields jsonb NOT NULL DEFAULT '[]'::jsonb,
  CONSTRAINT appointments_pkey PRIMARY KEY (id),
  CONSTRAINT appointments_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.articles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  slug text NOT NULL UNIQUE,
  title text NOT NULL,
  content text NOT NULL,
  excerpt text,
  featured_image text,
  author_name text DEFAULT 'فريق طبيبي'::text,
  published_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  status text DEFAULT 'published'::text CHECK (status = ANY (ARRAY['draft'::text, 'published'::text, 'archived'::text])),
  meta_title text,
  meta_description text,
  keywords ARRAY,
  views_count integer DEFAULT 0,
  CONSTRAINT articles_pkey PRIMARY KEY (id)
);
CREATE TABLE public.blocked_phones (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  clinic_id uuid NOT NULL,
  phone_number text NOT NULL,
  reason text,
  created_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  CONSTRAINT blocked_phones_pkey PRIMARY KEY (id),
  CONSTRAINT blocked_phones_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.booking_analytics (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  clinic_id uuid NOT NULL,
  visitor_id text,
  ip_address text,
  country text,
  city text,
  device_type text,
  browser text,
  event_type text CHECK (event_type = ANY (ARRAY['view'::text, 'conversion'::text, 'blocked_attempt'::text])),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT booking_analytics_pkey PRIMARY KEY (id)
);
CREATE TABLE public.booking_drafts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  clinic_id uuid NOT NULL,
  visitor_id text,
  session_id text,
  current_step integer,
  patient_name text,
  patient_phone text,
  selected_date text,
  selected_time text,
  form_data jsonb,
  ip_address text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  status text DEFAULT 'in_progress'::text CHECK (status = ANY (ARRAY['in_progress'::text, 'completed'::text, 'abandoned'::text])),
  CONSTRAINT booking_drafts_pkey PRIMARY KEY (id)
);
CREATE TABLE public.chat_conversations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  clinic_id text NOT NULL,
  title text DEFAULT 'محادثة جديدة'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  is_archived boolean DEFAULT false,
  CONSTRAINT chat_conversations_pkey PRIMARY KEY (id),
  CONSTRAINT chat_conversations_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.chat_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  conversation_id uuid NOT NULL,
  role text NOT NULL CHECK (role = ANY (ARRAY['user'::text, 'assistant'::text, 'system'::text])),
  content text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT chat_messages_pkey PRIMARY KEY (id),
  CONSTRAINT chat_messages_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.chat_conversations(id)
);
CREATE TABLE public.clinic_profile_analytics (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  clinic_id uuid NOT NULL,
  visitor_id uuid,
  event_type text NOT NULL CHECK (event_type = ANY (ARRAY['profile_view'::text, 'booking_click'::text, 'action_call'::text, 'action_whatsapp'::text, 'action_share'::text, 'action_location'::text])),
  metadata jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT clinic_profile_analytics_pkey PRIMARY KEY (id)
);
CREATE TABLE public.clinic_profile_settings (
  clinic_id uuid NOT NULL,
  settings jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT clinic_profile_settings_pkey PRIMARY KEY (clinic_id)
);
CREATE TABLE public.clinic_wallets (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  clinic_id uuid NOT NULL UNIQUE,
  balance numeric NOT NULL DEFAULT 0.00,
  currency text DEFAULT 'EGP'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT clinic_wallets_pkey PRIMARY KEY (id),
  CONSTRAINT clinic_wallets_clinic_id_fkey FOREIGN KEY (clinic_id) REFERENCES public.clinics(clinic_uuid)
);
CREATE TABLE public.clinics (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  name text,
  address text,
  booking_price integer,
  available_time jsonb,
  current_plan text,
  clinic_uuid uuid DEFAULT gen_random_uuid() UNIQUE,
  online_booking_enabled boolean DEFAULT true,
  clinic_id_bigint bigint,
  whatsapp_enabled boolean DEFAULT false,
  whatsapp_number text,
  prevent_conflicts boolean DEFAULT false,
  min_time_gap integer DEFAULT 30,
  CONSTRAINT clinics_pkey PRIMARY KEY (id),
  CONSTRAINT clinics_current_plan_fkey FOREIGN KEY (current_plan) REFERENCES public.plans(id)
);
CREATE TABLE public.daily_email_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  clinic_id uuid,
  email_to text NOT NULL,
  appointments_count integer NOT NULL DEFAULT 0,
  sent_at timestamp with time zone DEFAULT now(),
  status text DEFAULT 'sent'::text CHECK (status = ANY (ARRAY['sent'::text, 'failed'::text, 'skipped'::text])),
  error_message text,
  CONSTRAINT daily_email_logs_pkey PRIMARY KEY (id),
  CONSTRAINT daily_email_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.developer_transactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  wallet_id uuid NOT NULL,
  amount numeric NOT NULL,
  type text NOT NULL CHECK (type = ANY (ARRAY['earning'::text, 'withdrawal'::text, 'refund'::text, 'adjustment'::text])),
  description text,
  reference_id text,
  reference_type text,
  status text DEFAULT 'completed'::text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT developer_transactions_pkey PRIMARY KEY (id),
  CONSTRAINT developer_transactions_wallet_id_fkey FOREIGN KEY (wallet_id) REFERENCES public.developer_wallets(id)
);
CREATE TABLE public.developer_wallets (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  developer_id uuid NOT NULL UNIQUE,
  balance numeric NOT NULL DEFAULT 0.00,
  currency text DEFAULT 'EGP'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT developer_wallets_pkey PRIMARY KEY (id),
  CONSTRAINT developer_wallets_developer_id_fkey FOREIGN KEY (developer_id) REFERENCES public.app_developers(id)
);
CREATE TABLE public.discount_redemptions (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  discount_id bigint NOT NULL,
  clinic_id uuid,
  appointment_id bigint,
  patient_plan_id bigint,
  subscription_id bigint,
  redeemed_by bigint,
  amount_discounted numeric,
  CONSTRAINT discount_redemptions_pkey PRIMARY KEY (id),
  CONSTRAINT discount_redemptions_discount_id_fkey FOREIGN KEY (discount_id) REFERENCES public.discounts(id),
  CONSTRAINT discount_redemptions_appointment_id_fkey FOREIGN KEY (appointment_id) REFERENCES public.appointments(id),
  CONSTRAINT discount_redemptions_patient_plan_id_fkey FOREIGN KEY (patient_plan_id) REFERENCES public.patient_plans(id),
  CONSTRAINT discount_redemptions_subscription_id_fkey FOREIGN KEY (subscription_id) REFERENCES public.subscriptions(id),
  CONSTRAINT discount_redemptions_redeemed_by_fkey FOREIGN KEY (redeemed_by) REFERENCES public.users(id)
);
CREATE TABLE public.discounts (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  code text,
  is_percentage boolean,
  value real,
  is_active boolean,
  plan_id text,
  max_uses integer,
  used_count integer DEFAULT 0,
  expiration_date timestamp with time zone,
  message text,
  billing_period text DEFAULT 'both'::text CHECK (billing_period = ANY (ARRAY['monthly'::text, 'annual'::text, 'both'::text])),
  CONSTRAINT discounts_pkey PRIMARY KEY (id),
  CONSTRAINT discounts_plan_id_fkey FOREIGN KEY (plan_id) REFERENCES public.plans(id)
);
CREATE TABLE public.fcm_tokens (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  token text NOT NULL,
  device_type text DEFAULT 'web'::text,
  created_at timestamp with time zone DEFAULT now(),
  last_updated timestamp with time zone DEFAULT now(),
  CONSTRAINT fcm_tokens_pkey PRIMARY KEY (id),
  CONSTRAINT fcm_tokens_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.financial_records (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  clinic_id bigint NOT NULL,
  appointment_id bigint,
  patient_id bigint,
  patient_plan_id bigint,
  amount numeric NOT NULL,
  type text NOT NULL CHECK (type = ANY (ARRAY['income'::text, 'expense'::text, 'charge'::text])),
  description text NOT NULL,
  recorded_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  visit_id bigint,
  reference_key text,
  CONSTRAINT financial_records_pkey PRIMARY KEY (id),
  CONSTRAINT financial_records_appointment_id_fkey FOREIGN KEY (appointment_id) REFERENCES public.appointments(id),
  CONSTRAINT financial_records_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id),
  CONSTRAINT financial_records_patient_plan_id_fkey FOREIGN KEY (patient_plan_id) REFERENCES public.patient_plans(id),
  CONSTRAINT financial_records_visit_id_fkey FOREIGN KEY (visit_id) REFERENCES public.visits(id)
);
CREATE TABLE public.integrations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  clinic_id uuid,
  provider text NOT NULL,
  integration_type text NOT NULL,
  access_token text,
  refresh_token text,
  expires_at timestamp with time zone,
  scope text,
  token_type text,
  id_token text,
  is_active boolean DEFAULT true,
  settings jsonb DEFAULT '{}'::jsonb,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT integrations_pkey PRIMARY KEY (id),
  CONSTRAINT integrations_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.notifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  type character varying NOT NULL,
  title character varying NOT NULL,
  message text,
  clinic_id uuid NOT NULL,
  is_read boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  related_id character varying,
  appointment_id bigint,
  patient_id bigint,
  image_url text,
  action_link text,
  action_text text,
  action_buttons jsonb,
  CONSTRAINT notifications_pkey PRIMARY KEY (id)
);
CREATE TABLE public.patient_attachments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  created_at timestamp with time zone DEFAULT now(),
  patient_id bigint,
  clinic_id uuid,
  file_name text,
  file_url text NOT NULL,
  file_type text,
  category text,
  description text,
  CONSTRAINT patient_attachments_pkey PRIMARY KEY (id),
  CONSTRAINT patient_attachments_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.patient_plans (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  template_id bigint,
  total_sessions integer,
  completed_sessions integer,
  status text,
  patient_id bigint,
  total_price bigint,
  clinic_id uuid,
  updated_at timestamp with time zone DEFAULT now(),
  advanced_settings jsonb NOT NULL DEFAULT '{}'::jsonb,
  CONSTRAINT patient_plans_pkey PRIMARY KEY (id),
  CONSTRAINT patient_plans_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.treatment_templates(id),
  CONSTRAINT patient_plans_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.patients (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  name text,
  phone text,
  address text,
  date_of_birth text,
  blood_type text,
  gender text,
  clinic_id uuid,
  age integer,
  updated_at timestamp with time zone DEFAULT now(),
  age_unit text DEFAULT 'years'::text,
  job text,
  marital_status text,
  email text,
  notes text,
  medical_history jsonb DEFAULT '{}'::jsonb,
  insurance_info jsonb DEFAULT '{}'::jsonb,
  custom_fields jsonb NOT NULL DEFAULT '[]'::jsonb,
  CONSTRAINT patients_pkey PRIMARY KEY (id)
);
CREATE TABLE public.plan_pricing (
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  price real,
  id text NOT NULL,
  features jsonb,
  popular boolean,
  name text,
  description text,
  CONSTRAINT plan_pricing_pkey PRIMARY KEY (id)
);
CREATE TABLE public.plans (
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  id text NOT NULL,
  name text,
  limits jsonb,
  price numeric,
  CONSTRAINT plans_pkey PRIMARY KEY (id)
);
CREATE TABLE public.subscriptions (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  plan_id text,
  status text DEFAULT 'active'::text,
  current_period_start timestamp with time zone,
  current_period_end timestamp with time zone,
  payment_method text,
  billing_period text DEFAULT 'monthly'::text CHECK (billing_period = ANY (ARRAY['monthly'::text, 'annual'::text])),
  amount numeric,
  clinic_id uuid,
  CONSTRAINT subscriptions_pkey PRIMARY KEY (id),
  CONSTRAINT subscriptions_plan_id_fkey FOREIGN KEY (plan_id) REFERENCES public.plans(id)
);
CREATE TABLE public.tabibi_app_audit_logs (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  app_id bigint NOT NULL,
  clinic_id uuid NOT NULL,
  action text NOT NULL,
  resource text,
  metadata jsonb,
  severity text DEFAULT 'info'::text,
  timestamp timestamp with time zone DEFAULT now(),
  CONSTRAINT tabibi_app_audit_logs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.tabibi_app_event_subscriptions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  app_id bigint NOT NULL,
  event_type text NOT NULL,
  handler_function_name text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tabibi_app_event_subscriptions_pkey PRIMARY KEY (id),
  CONSTRAINT tabibi_app_event_subscriptions_app_id_fkey FOREIGN KEY (app_id) REFERENCES public.tabibi_marketplace_apps(id)
);
CREATE TABLE public.tabibi_app_installations (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  clinic_id uuid NOT NULL,
  app_id bigint NOT NULL,
  installed_version_id uuid,
  auto_update boolean DEFAULT true,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'trialing'::text, 'past_due'::text, 'cancelled'::text, 'suspended'::text])),
  trial_ends_at timestamp with time zone,
  current_period_end timestamp with time zone,
  is_frozen boolean DEFAULT false,
  settings jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tabibi_app_installations_pkey PRIMARY KEY (id),
  CONSTRAINT tabibi_app_installations_app_id_fkey FOREIGN KEY (app_id) REFERENCES public.tabibi_marketplace_apps(id),
  CONSTRAINT tabibi_app_installations_installed_version_id_fkey FOREIGN KEY (installed_version_id) REFERENCES public.tabibi_app_versions(id)
);
CREATE TABLE public.tabibi_app_reviews (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  app_id bigint NOT NULL,
  clinic_id uuid NOT NULL,
  user_id uuid NOT NULL,
  rating integer CHECK (rating >= 1 AND rating <= 5),
  comment text,
  is_verified_purchase boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tabibi_app_reviews_pkey PRIMARY KEY (id),
  CONSTRAINT tabibi_app_reviews_app_id_fkey FOREIGN KEY (app_id) REFERENCES public.tabibi_marketplace_apps(id)
);
CREATE TABLE public.tabibi_app_schema_requests (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  app_id bigint NOT NULL,
  developer_id uuid NOT NULL,
  table_name text NOT NULL,
  sql_structure text NOT NULL,
  purpose text NOT NULL,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'approved'::text, 'applied'::text, 'rejected'::text])),
  admin_response text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tabibi_app_schema_requests_pkey PRIMARY KEY (id),
  CONSTRAINT tabibi_app_schema_requests_app_id_fkey FOREIGN KEY (app_id) REFERENCES public.tabibi_marketplace_apps(id),
  CONSTRAINT tabibi_app_schema_requests_developer_id_fkey FOREIGN KEY (developer_id) REFERENCES public.tabibi_developers(id)
);
CREATE TABLE public.tabibi_app_scopes (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  scope_code text NOT NULL UNIQUE,
  description text NOT NULL,
  category text NOT NULL,
  risk_level text DEFAULT 'low'::text CHECK (risk_level = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text])),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tabibi_app_scopes_pkey PRIMARY KEY (id)
);
CREATE TABLE public.tabibi_app_version_scopes (
  version_id uuid NOT NULL,
  scope_id uuid NOT NULL,
  justification text,
  CONSTRAINT tabibi_app_version_scopes_pkey PRIMARY KEY (version_id, scope_id),
  CONSTRAINT tabibi_app_version_scopes_version_id_fkey FOREIGN KEY (version_id) REFERENCES public.tabibi_app_versions(id),
  CONSTRAINT tabibi_app_version_scopes_scope_id_fkey FOREIGN KEY (scope_id) REFERENCES public.tabibi_app_scopes(id)
);
CREATE TABLE public.tabibi_app_versions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  app_id bigint NOT NULL,
  version_number text NOT NULL,
  js_entry_point text,
  css_bundle text,
  status text DEFAULT 'draft'::text CHECK (status = ANY (ARRAY['draft'::text, 'submitted'::text, 'in_review'::text, 'approved'::text, 'rejected'::text, 'archived'::text])),
  reviewer_notes text,
  rejection_reason text,
  changelog text,
  created_at timestamp with time zone DEFAULT now(),
  published_at timestamp with time zone,
  CONSTRAINT tabibi_app_versions_pkey PRIMARY KEY (id),
  CONSTRAINT tabibi_app_versions_app_id_fkey FOREIGN KEY (app_id) REFERENCES public.tabibi_marketplace_apps(id)
);
CREATE TABLE public.tabibi_apps (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  title text NOT NULL,
  short_description text,
  full_description text,
  price numeric DEFAULT 0,
  billing_period text DEFAULT 'monthly'::text CHECK (billing_period = ANY (ARRAY['monthly'::text, 'yearly'::text, 'one_time'::text])),
  image_url text,
  category text,
  features jsonb DEFAULT '[]'::jsonb,
  screenshots jsonb DEFAULT '[]'::jsonb,
  component_key text UNIQUE,
  is_active boolean DEFAULT true,
  color text,
  preview_link text,
  developer_id uuid,
  submission_schema jsonb DEFAULT '{}'::jsonb,
  images jsonb DEFAULT '[]'::jsonb,
  views_count bigint DEFAULT 0,
  integration_type text DEFAULT 'none'::text CHECK (integration_type = ANY (ARRAY['none'::text, 'full'::text, 'partial'::text])),
  integration_target text,
  icon_name text,
  pricing_type text CHECK (pricing_type = ANY (ARRAY['free'::text, 'paid'::text, 'trial_then_paid'::text])),
  payment_type text CHECK (payment_type = ANY (ARRAY['one_time'::text, 'recurring'::text])),
  billing_interval_unit text CHECK (billing_interval_unit = ANY (ARRAY['day'::text, 'week'::text, 'month'::text, 'year'::text])),
  billing_interval_count integer CHECK (billing_interval_count IS NULL OR billing_interval_count > 0),
  trial_interval_unit text CHECK (trial_interval_unit IS NULL OR (trial_interval_unit = ANY (ARRAY['day'::text, 'week'::text, 'month'::text, 'year'::text]))),
  trial_interval_count integer CHECK (trial_interval_count IS NULL OR trial_interval_count > 0),
  currency text,
  CONSTRAINT tabibi_apps_pkey PRIMARY KEY (id),
  CONSTRAINT tabibi_apps_developer_id_fkey FOREIGN KEY (developer_id) REFERENCES public.app_developers(id)
);
CREATE TABLE public.tabibi_developers (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  name text NOT NULL,
  email text NOT NULL,
  website text,
  verification_status text DEFAULT 'unverified'::text CHECK (verification_status = ANY (ARRAY['unverified'::text, 'pending'::text, 'verified'::text, 'suspended'::text])),
  developer_key text DEFAULT encode(gen_random_bytes(16), 'hex'::text) UNIQUE,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tabibi_developers_pkey PRIMARY KEY (id),
  CONSTRAINT tabibi_developers_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.tabibi_marketplace_apps (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  developer_id uuid NOT NULL,
  title text NOT NULL,
  slug text NOT NULL UNIQUE,
  short_description text,
  full_description text,
  icon_url text,
  cover_image_url text,
  category text,
  tags ARRAY,
  is_paid boolean DEFAULT false,
  price_monthly numeric DEFAULT 0,
  price_yearly numeric DEFAULT 0,
  has_free_trial boolean DEFAULT false,
  trial_days integer DEFAULT 0,
  is_featured boolean DEFAULT false,
  kill_switch_active boolean DEFAULT false,
  kill_switch_reason text,
  install_count bigint DEFAULT 0,
  average_rating numeric DEFAULT 0.00,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tabibi_marketplace_apps_pkey PRIMARY KEY (id),
  CONSTRAINT tabibi_marketplace_apps_developer_id_fkey FOREIGN KEY (developer_id) REFERENCES public.tabibi_developers(id)
);
CREATE TABLE public.transactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  reference_number integer NOT NULL DEFAULT nextval('transactions_reference_number_seq'::regclass),
  created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  user_id uuid,
  clinic_id uuid,
  easykash_ref text,
  amount numeric NOT NULL,
  currency text DEFAULT 'EGP'::text,
  status USER-DEFINED DEFAULT 'pending'::payment_status,
  type USER-DEFINED NOT NULL,
  metadata jsonb DEFAULT '{}'::jsonb,
  response_data jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT transactions_pkey PRIMARY KEY (id),
  CONSTRAINT transactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.treatment_templates (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  name text,
  session_count integer,
  session_price integer,
  description text,
  clinic_id uuid,
  updated_at timestamp with time zone DEFAULT now(),
  advanced_settings jsonb NOT NULL DEFAULT '{}'::jsonb,
  CONSTRAINT treatment_templates_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_preferences (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  theme_mode text DEFAULT 'light'::text CHECK (theme_mode = ANY (ARRAY['light'::text, 'dark'::text, 'system'::text])),
  primary_color character varying DEFAULT '#1AA19C'::character varying,
  secondary_color character varying DEFAULT '#224FB5'::character varying,
  accent_color character varying DEFAULT '#FF6B6B'::character varying,
  logo_url text,
  company_name text,
  menu_items jsonb DEFAULT '[]'::jsonb,
  sidebar_collapsed boolean DEFAULT false,
  sidebar_style text DEFAULT 'default'::text CHECK (sidebar_style = ANY (ARRAY['default'::text, 'compact'::text, 'full'::text])),
  language text DEFAULT 'ar'::text CHECK (language = ANY (ARRAY['ar'::text, 'en'::text])),
  notifications_enabled boolean DEFAULT true,
  sound_notifications boolean DEFAULT true,
  dashboard_widgets jsonb DEFAULT '[]'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  daily_appointments_email_enabled boolean DEFAULT false,
  daily_appointments_email_time text DEFAULT '07:00'::text,
  timezone text DEFAULT 'Africa/Cairo'::text,
  tabibi_ai_settings jsonb DEFAULT '{}'::jsonb,
  medical_fields_config jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT user_preferences_pkey PRIMARY KEY (id),
  CONSTRAINT user_preferences_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.users (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  name text,
  phone text,
  role text,
  permissions text,
  email text,
  user_id text,
  clinic_id uuid,
  auth_uid uuid,
  clinic_id_bigint bigint,
  avatar_url text,
  bio text,
  education jsonb DEFAULT '[]'::jsonb,
  certificates jsonb DEFAULT '[]'::jsonb,
  specialty text,
  banner_url text,
  contacts jsonb DEFAULT '[]'::jsonb,
  CONSTRAINT users_pkey PRIMARY KEY (id)
);
CREATE TABLE public.visits (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  patient_id bigint,
  diagnosis text,
  notes text,
  medications jsonb,
  clinic_id uuid,
  patient_plan_id bigint,
  treatment text,
  follow_up text,
  custom_fields jsonb DEFAULT '[]'::jsonb,
  CONSTRAINT visits_pkey PRIMARY KEY (id),
  CONSTRAINT visits_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.wallet_transactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  wallet_id uuid NOT NULL,
  amount numeric NOT NULL,
  type text NOT NULL CHECK (type = ANY (ARRAY['deposit'::text, 'payment'::text, 'refund'::text, 'adjustment'::text, 'bonus'::text])),
  description text,
  reference_type text,
  reference_id text,
  status text DEFAULT 'completed'::text CHECK (status = ANY (ARRAY['pending'::text, 'completed'::text, 'failed'::text, 'cancelled'::text])),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT wallet_transactions_pkey PRIMARY KEY (id),
  CONSTRAINT wallet_transactions_wallet_id_fkey FOREIGN KEY (wallet_id) REFERENCES public.clinic_wallets(id)
);
CREATE TABLE public.whatsapp_message_logs (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  clinic_id uuid NOT NULL,
  patient_id bigint,
  appointment_id bigint,
  message_type text,
  status text DEFAULT 'sent'::text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT whatsapp_message_logs_pkey PRIMARY KEY (id),
  CONSTRAINT whatsapp_message_logs_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id),
  CONSTRAINT whatsapp_message_logs_appointment_id_fkey FOREIGN KEY (appointment_id) REFERENCES public.appointments(id)
);
CREATE TABLE public.whatsapp_settings (
  clinic_id uuid NOT NULL UNIQUE,
  enabled boolean DEFAULT false,
  whatsapp_number text,
  reminder_days_before integer DEFAULT 1,
  reminder_time text DEFAULT '09:00'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now()
);
CREATE TABLE public.withdrawal_requests (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  developer_id uuid NOT NULL,
  wallet_id uuid NOT NULL,
  amount numeric NOT NULL,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'approved'::text, 'rejected'::text, 'processed'::text])),
  bank_details text,
  admin_note text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT withdrawal_requests_pkey PRIMARY KEY (id),
  CONSTRAINT withdrawal_requests_developer_id_fkey FOREIGN KEY (developer_id) REFERENCES public.app_developers(id),
  CONSTRAINT withdrawal_requests_wallet_id_fkey FOREIGN KEY (wallet_id) REFERENCES public.developer_wallets(id)
);