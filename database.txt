-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.appointments (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  patient_id bigint,
  date text,
  notes text,
  status text,
  price bigint,
  from text,
  clinic_id uuid,
  age bigint,
  CONSTRAINT appointments_pkey PRIMARY KEY (id),
  CONSTRAINT appointment_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.chat_conversations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  clinic_id text NOT NULL,
  title text DEFAULT 'محادثة جديدة'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  is_archived boolean DEFAULT false,
  CONSTRAINT chat_conversations_pkey PRIMARY KEY (id),
  CONSTRAINT chat_conversations_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.chat_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  conversation_id uuid NOT NULL,
  role text NOT NULL CHECK (role = ANY (ARRAY['user'::text, 'assistant'::text, 'system'::text])),
  content text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT chat_messages_pkey PRIMARY KEY (id),
  CONSTRAINT chat_messages_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.chat_conversations(id)
);
CREATE TABLE public.clinics (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  name text,
  address text,
  booking_price integer,
  available_time jsonb,
  current_plan text,
  clinic_uuid uuid DEFAULT gen_random_uuid(),
  online_booking_enabled boolean DEFAULT true,
  clinic_id_bigint bigint,
  CONSTRAINT clinics_pkey PRIMARY KEY (id),
  CONSTRAINT clinics_current_plan_fkey FOREIGN KEY (current_plan) REFERENCES public.plans(id)
);
CREATE TABLE public.daily_email_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  clinic_id uuid,
  email_to text NOT NULL,
  appointments_count integer NOT NULL DEFAULT 0,
  sent_at timestamp with time zone DEFAULT now(),
  status text DEFAULT 'sent'::text CHECK (status = ANY (ARRAY['sent'::text, 'failed'::text, 'skipped'::text])),
  error_message text,
  CONSTRAINT daily_email_logs_pkey PRIMARY KEY (id),
  CONSTRAINT daily_email_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.discount_redemptions (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  discount_id bigint NOT NULL,
  clinic_id uuid,
  appointment_id bigint,
  patient_plan_id bigint,
  subscription_id bigint,
  redeemed_by bigint,
  amount_discounted numeric,
  CONSTRAINT discount_redemptions_pkey PRIMARY KEY (id),
  CONSTRAINT discount_redemptions_discount_id_fkey FOREIGN KEY (discount_id) REFERENCES public.discounts(id),
  CONSTRAINT discount_redemptions_appointment_id_fkey FOREIGN KEY (appointment_id) REFERENCES public.appointments(id),
  CONSTRAINT discount_redemptions_patient_plan_id_fkey FOREIGN KEY (patient_plan_id) REFERENCES public.patient_plans(id),
  CONSTRAINT discount_redemptions_subscription_id_fkey FOREIGN KEY (subscription_id) REFERENCES public.subscriptions(id),
  CONSTRAINT discount_redemptions_redeemed_by_fkey FOREIGN KEY (redeemed_by) REFERENCES public.users(id)
);
CREATE TABLE public.discounts (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  code text,
  is_percentage boolean,
  value real,
  is_active boolean,
  plan_id text,
  max_uses integer,
  used_count integer DEFAULT 0,
  expiration_date timestamp with time zone,
  message text,
  billing_period text DEFAULT 'both'::text CHECK (billing_period = ANY (ARRAY['monthly'::text, 'annual'::text, 'both'::text])),
  CONSTRAINT discounts_pkey PRIMARY KEY (id),
  CONSTRAINT discounts_plan_id_fkey FOREIGN KEY (plan_id) REFERENCES public.plans(id)
);
CREATE TABLE public.fcm_tokens (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  token text NOT NULL,
  device_type text DEFAULT 'web'::text,
  created_at timestamp with time zone DEFAULT now(),
  last_updated timestamp with time zone DEFAULT now(),
  CONSTRAINT fcm_tokens_pkey PRIMARY KEY (id),
  CONSTRAINT fcm_tokens_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.financial_records (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  clinic_id bigint NOT NULL,
  appointment_id bigint,
  patient_id bigint,
  patient_plan_id bigint,
  amount numeric NOT NULL,
  type text NOT NULL CHECK (type = ANY (ARRAY['income'::text, 'expense'::text])),
  description text NOT NULL,
  recorded_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT financial_records_pkey PRIMARY KEY (id),
  CONSTRAINT financial_records_appointment_id_fkey FOREIGN KEY (appointment_id) REFERENCES public.appointments(id),
  CONSTRAINT financial_records_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id),
  CONSTRAINT financial_records_patient_plan_id_fkey FOREIGN KEY (patient_plan_id) REFERENCES public.patient_plans(id)
);
CREATE TABLE public.integrations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  clinic_id uuid,
  provider text NOT NULL,
  integration_type text NOT NULL,
  access_token text,
  refresh_token text,
  expires_at timestamp with time zone,
  scope text,
  is_active boolean DEFAULT true,
  settings jsonb DEFAULT '{}'::jsonb,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT integrations_pkey PRIMARY KEY (id),
  CONSTRAINT integrations_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.notifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  type character varying NOT NULL,
  title character varying NOT NULL,
  message text,
  clinic_id uuid NOT NULL,
  is_read boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  related_id character varying,
  appointment_id bigint,
  patient_id bigint,
  CONSTRAINT notifications_pkey PRIMARY KEY (id)
);
CREATE TABLE public.patient_plans (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  template_id bigint,
  total_sessions integer,
  completed_sessions integer,
  status text,
  patient_id bigint,
  total_price bigint,
  clinic_id uuid,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT patient_plans_pkey PRIMARY KEY (id),
  CONSTRAINT patient_plans_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.treatment_templates(id),
  CONSTRAINT patient_plans_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.patients (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  name text,
  phone text,
  address text,
  date_of_birth text,
  blood_type text,
  gender text,
  clinic_id uuid,
  age integer,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT patients_pkey PRIMARY KEY (id)
);
CREATE TABLE public.plan_pricing (
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  price real,
  id text NOT NULL,
  features jsonb,
  popular boolean,
  name text,
  description text,
  CONSTRAINT plan_pricing_pkey PRIMARY KEY (id)
);
CREATE TABLE public.plans (
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  id text NOT NULL,
  name text,
  limits jsonb,
  price numeric,
  CONSTRAINT plans_pkey PRIMARY KEY (id)
);
CREATE TABLE public.subscriptions (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  plan_id text,
  status text DEFAULT 'active'::text,
  current_period_start timestamp with time zone,
  current_period_end timestamp with time zone,
  payment_method text,
  billing_period text DEFAULT 'monthly'::text CHECK (billing_period = ANY (ARRAY['monthly'::text, 'annual'::text])),
  amount numeric,
  clinic_id uuid,
  CONSTRAINT subscriptions_pkey PRIMARY KEY (id),
  CONSTRAINT subscriptions_plan_id_fkey FOREIGN KEY (plan_id) REFERENCES public.plans(id)
);
CREATE TABLE public.treatment_templates (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  name text,
  session_count integer,
  session_price integer,
  description text,
  clinic_id uuid,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT treatment_templates_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_preferences (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  theme_mode text DEFAULT 'system'::text CHECK (theme_mode = ANY (ARRAY['light'::text, 'dark'::text, 'system'::text])),
  primary_color character varying DEFAULT '#1AA19C'::character varying,
  secondary_color character varying DEFAULT '#224FB5'::character varying,
  accent_color character varying DEFAULT '#FF6B6B'::character varying,
  logo_url text,
  company_name text,
  menu_items jsonb DEFAULT '[]'::jsonb,
  sidebar_collapsed boolean DEFAULT false,
  sidebar_style text DEFAULT 'default'::text CHECK (sidebar_style = ANY (ARRAY['default'::text, 'compact'::text, 'full'::text])),
  language text DEFAULT 'ar'::text CHECK (language = ANY (ARRAY['ar'::text, 'en'::text])),
  notifications_enabled boolean DEFAULT true,
  sound_notifications boolean DEFAULT true,
  dashboard_widgets jsonb DEFAULT '[]'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  daily_appointments_email_enabled boolean DEFAULT false,
  daily_appointments_email_time text DEFAULT '07:00'::text,
  timezone text DEFAULT 'Africa/Cairo'::text,
  CONSTRAINT user_preferences_pkey PRIMARY KEY (id),
  CONSTRAINT user_preferences_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.users (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  name text,
  phone text,
  role text,
  permissions text,
  email text,
  user_id text,
  clinic_id uuid,
  auth_uid uuid,
  clinic_id_bigint bigint,
  CONSTRAINT users_pkey PRIMARY KEY (id)
);
CREATE TABLE public.visits (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  patient_id bigint,
  diagnosis text,
  notes text,
  medications jsonb,
  clinic_id uuid,
  patient_plan_id bigint,
  CONSTRAINT visits_pkey PRIMARY KEY (id),
  CONSTRAINT visits_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);